# GB28181协议

## 1 协议介绍

GB28181 = SIP(会话通道) + RTP/RTCP(媒体流通道)

SIP = UAC(客户端)  +  UAS (服务端)

### 1.1 注册

<img src="../image/GB28181协议/image-20220210180830659.png" alt="image-20220210180830659" style="zoom:80%;" />

请求信息范例

> 1 REGISTER sip:34020000002000000001@3402000000 SIP/2.0
>
> 2 Via: SIP/2.0/UDP 192.168.137.11:5060;rport;branch=z9hG4bK1371463273
>
> 3 From: sip:34020000001320000003@3402000000;tag=2043466181
>
> 4 To: sip:34020000001320000003@3402000000
>
> 5 Call-ID: 1011047669
>
> 6 CSeq: 1 REGISTER
>
> 7 Contact: sip:34020000001320000003@192.168.137.11:5060
>
> 8 Max-Forwards: 70
>
> 9 User-Agent: IP Camera
>
> 10 Expires: 3600
>
> 11 Content-Length: 0

- 第1行表明这条SIP消息的方法（Method）是REGISTER，34020000002000000001是SIP服务器的国标ID，国标ID指的是由中心编码(8位) 、行业编码(2位) 、类型编码(3位)和序号(7位)四个码段共20位十进制数字字符构成，具体国标ID的编码方法可以参考GB/T 28181—2016中的附录D。3402000000指的是SIP服务器的域国标ID，SIP/2.0指的是SIP协议版本。
- 第2行为Via头，Via头中包含了发送请求方的相关信息，后续需要使用这些信息进行回复。SIP/2.0/UDP表示使用的是2.0版本的SIP协议，使用的传输协议是UDP，也可以使用TCP协议。192.168.137.11:5060为请求发送方的IP地址和端口号。Via头中必须包含branch参数，具体值是一个在整个SIP通信过程中不重复的数值。branch是一个事务ID（Transaction ID），用于区分同一个UA所发起的不同Transaction，它不会对未来的request或者是response造成影响，对于遵循IETF RFC3261规范的实现，这个branch参数的值必须用”z9hG4bK”打头. 其它部分是对To， From, Call-ID头域和Request-URI按一定的算法加密后得到。rport字段表示使用rport机制路由响应，即发送的响应时，按照rport中的端口发送SIP响应，也就是说IP和端口均完全遵照从哪里来的，发回哪里去的原则，如果没有rport字段时，服务端的策略是IP使用UDP包中的地址，即从哪里来回哪里去，但是端口使用的是via中的端口，详情见IETF RFC35818。
- 第3行为From头，From头中包含了请求发送方的逻辑标识，在GB28181协议中是发送请求的设备国标ID和域国标ID信息。tag参数是为了身份认证的，值为随机数字字符。
- 第4行为To头，To头在SIP协议中是为了标明请求接收方的逻辑标识的，在GB28181协议中填写的是发送请求的设备国标ID和域国标ID信息。
- 第5行为Call-ID头，Call-ID头是全局唯一的，在同一个session中保持一致，在不同session中不同。
- 第6行为CSeq头，CSeq头又叫Command Seqence（命令队列），用于标识命令顺序，值为序号+Method，序号部分为无符号整数，最大值为2^31。序号起始值是随机的，后续在同一个session中依次递增，比如发1 REGISTER没返回--->再发2 REGISTER--->没返回--->再发3 REGISTER--->这时返回了2 REGISTER就知道是第2个请求得到了响应。对于ACK和CANCLE中的CSeq与INVITE中的Cseq保持一致。
- 第7行为Contact头，Contact头包含源的URI信息，用来给响应消息直接和源建立连接用。在GB28181协议中为SIP设备编码@源IP地址端口。
- 第8行为Max-Forwards头，Max-Forwards头用于设置包最大中转次数，默认是70。
- 第9行为User-Agent头，User-Agent头用于设置关于UA的信息，用户可以自定义。
- 第10行为Expires头，Expires头表示超时时间。
- 第11行为Content-Length头，Content-Length头表示SDP消息的长度，因为REGISTER消息不需要SDP，因此为0。

注册的回复消息内容范例如下：

> 1 SIP/2.0 200 OK
>
> 2 Via: SIP/2.0/UDP 192.168.137.11:5060;rport;branch=z9hG4bK1371463273
>
> 3 From: sip:34020000001320000003@3402000000
>
> 4 To: sip:34020000001320000003@3402000000
>
> 5 CSeq: 1 REGISTER
>
> 6 Call-ID: 1011047669
>
> 7 Contact: sip:34020000001320000003@192.168.137.11:5060
>
> 8 User-Agent: FFmpeg GB28181 v1.0
>
> 9 Expires: 3600
>
> 10 Content-Length: 0

### 1.2 保活

<img src="../image/GB28181协议/image-20220210181357959.png" alt="image-20220210181357959" style="zoom:80%;" />

保活消息内容范例如下：

> 1 MESSAGE sip:34020000002000000001@3402000000 SIP/2.0
>
> 2 Via: SIP/2.0/UDP 192.168.137.11:5060;rport;branch=z9hG4bK1066375804
>
> 3 From: sip:34020000001320000003@3402000000;tag=1925919231
>
> 4 To: sip:34020000002000000001@3402000000
>
> 5 Call-ID: 1185236415
>
> 6 CSeq: 20 MESSAGE
>
> 7 Content-Type: Application/MANSCDP+xml
>
> 8 Max-Forwards: 70
>
> 9 User-Agent: IP Camera
>
> 10 Content-Length: 175
>
> 11 <?xml version="1.0" encoding="UTF-8"?>
>
> 12 <Notify>
>
> 13 <CmdType>Keepalive
>
> 14 <SN>1
>
> 15 <DeviceID>34020000001320000003
>
> 16 <Status>OK
>
> 17 <Info>
>
> 18 </Info>
>
> 19 </Notify>

Message回复消息内容范例如下：

> 1 SIP/2.0 200 OK
>
> 2 Via: SIP/2.0/UDP 192.168.137.11:5060;rport;branch=z9hG4bK1066375804
>
> 3 From: sip:34020000001320000003@3402000000
>
> 4 To: sip:34020000002000000001@3402000000
>
> 5 CSeq: 20 MESSAGE
>
> 6 Call-ID: 1185236415
>
> 7 User-Agent: FFmpeg GB28181 v1.0
>
> 8 Content-Length: 0

### 1.3 实时视频播放

![image-20220210181831431](../image/GB28181协议/image-20220210181831431.png)

